<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Commander des extras</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#0b0b0f; color:#f5f5f7; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    .hero { padding: 18px 0 10px; }
    .hero h1 { margin: 0 0 8px; font-size: 28px; letter-spacing: .2px; }
    .hero p { margin: 0; opacity: .85; }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 14px; margin-top: 18px; }
    @media (min-width: 860px){ .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    .card { background: #12121a; border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 14px; }
    .card h3 { margin: 0 0 8px; font-size: 16px; }
    .price { opacity: .9; margin-bottom: 10px; }
    .desc { opacity: .75; font-size: 13px; line-height: 1.35; margin: 0 0 12px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .btn { cursor:pointer; border: 0; border-radius: 12px; padding: 10px 12px; background:#e11d48; color:#fff; font-weight: 650; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .qty { display:flex; align-items:center; gap: 8px; }
    .qbtn { width: 34px; height: 34px; border-radius: 10px; border: 1px solid rgba(255,255,255,.12); background:#0f0f16; color:#fff; font-size: 18px; cursor:pointer; }
    .qval { min-width: 20px; text-align:center; font-weight: 650; }
    .sticky { position: sticky; bottom: 0; margin-top: 18px; padding: 12px; background: rgba(10,10,15,.92); backdrop-filter: blur(8px);
              border: 1px solid rgba(255,255,255,.10); border-radius: 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .small { opacity:.75; font-size: 12px; }
    .total { font-size: 16px; font-weight: 800; }
    .notice { margin-top: 10px; opacity:.75; font-size: 12px; }
    a { color: inherit; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Ajoutez une touche luxe à votre séjour</h1>
      <p>Choisissez vos extras, puis validez en une seule commande (paiement sécurisé).</p>
    </div>

    <div id="products" class="grid"></div>

    <div class="sticky">
      <div>
        <div class="total">Total : <span id="total">0,00 €</span></div>
        <div class="small"><span id="count">0</span> article(s) dans le panier</div>
      </div>
      <button id="checkout" class="btn" disabled>Commander</button>
    </div>

    <div class="notice">
      Livraison discrète • Si besoin : <a href="mailto:contact@elok.fr">contact@elok.fr</a>
    </div>
  </div>

<script>
  /**
   * IMPORTANT
   * - "priceId" ici est un ID STRIPE PRICE (ex: price_...).
   * - "unitAmount" ici est juste pour afficher un total sur la landing (UX).
   *   Le vrai montant facturé sera celui du backend via Stripe (liste blanche).
   */
  const PRODUCTS = [
    { id: "champagne", name: "Champagne", unitAmount: 5000, priceId: "price_CHAMPAGNE", desc: "Bouteille 75cl, fraîche et prête à savourer." },
    { id: "prosecco",  name: "Prosecco",  unitAmount: 5000, priceId: "price_PROSECCO",  desc: "Fines bulles italiennes, parfait pour démarrer la soirée." },
    { id: "vin_blanc", name: "Vin blanc", unitAmount: 2500, priceId: "price_VINBLANC",  desc: "Coteaux du Giennois blanc, délicat et élégant." },
    { id: "petitdej",  name: "Petit déjeuner", unitAmount: 3500, priceId: "price_PETITDEJ", desc: "Déposé discrètement, réveil tout en douceur." },
    { id: "chocolats", name: "Chocolats", unitAmount: 1500, priceId: "price_CHOCO",     desc: "Assortiment gourmand à partager." },
    { id: "bougies",   name: "Bougies", unitAmount: 1200, priceId: "price_BOUGIES",    desc: "Ambiance feutrée instantanée." },
    { id: "roses",     name: "Roses", unitAmount: 2500, priceId: "price_ROSES",        desc: "Une attention romantique à l’arrivée." },
    { id: "late",      name: "Late check-out", unitAmount: 2000, priceId: "price_LATE", desc: "Profitez plus longtemps (selon disponibilité)." },
    { id: "massage",   name: "Massage (sur demande)", unitAmount: 9000, priceId: "price_MASSAGE", desc: "Prestation partenaire (créneau confirmé après achat)." },
    { id: "pack",      name: "Pack romantique", unitAmount: 6900, priceId: "price_PACK", desc: "Ambiance + gourmandises (best-seller)." }
  ];

  const cart = new Map(); // productId -> quantity

  const fmt = (cents) => (cents/100).toLocaleString("fr-FR", { style:"currency", currency:"EUR" });

  function renderProducts(){
    const root = document.getElementById("products");
    root.innerHTML = "";

    PRODUCTS.forEach(p => {
      const qty = cart.get(p.id) || 0;

      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <h3>${p.name}</h3>
        <div class="price">${fmt(p.unitAmount)}</div>
        <p class="desc">${p.desc}</p>
        <div class="row">
          <div class="qty">
            <button class="qbtn" data-act="dec" data-id="${p.id}">−</button>
            <div class="qval" id="q_${p.id}">${qty}</div>
            <button class="qbtn" data-act="inc" data-id="${p.id}">+</button>
          </div>
          <button class="btn" data-act="add1" data-id="${p.id}">Ajouter</button>
        </div>
      `;
      root.appendChild(el);
    });

    root.addEventListener("click", onClickProducts, { once: true });
  }

  function onClickProducts(e){
    const btn = e.target.closest("button");
    if(!btn) return;

    const act = btn.dataset.act;
    const id = btn.dataset.id;
    const p = PRODUCTS.find(x => x.id === id);
    if(!p) return;

    const current = cart.get(id) || 0;

    if(act === "inc" || act === "add1") cart.set(id, current + 1);
    if(act === "dec") cart.set(id, Math.max(0, current - 1));

    if(cart.get(id) === 0) cart.delete(id);

    updateUI();
    renderProducts(); // simple & robuste (10 produits = ok)
  }

  function computeTotal(){
    let total = 0;
    let count = 0;
    for (const [id, qty] of cart.entries()){
      const p = PRODUCTS.find(x => x.id === id);
      if(!p) continue;
      total += p.unitAmount * qty;
      count += qty;
    }
    return { total, count };
  }

  function updateUI(){
    const { total, count } = computeTotal();
    document.getElementById("total").textContent = fmt(total);
    document.getElementById("count").textContent = String(count);

    const checkoutBtn = document.getElementById("checkout");
    checkoutBtn.disabled = count === 0;
  }

  async function checkout(){
    const checkoutBtn = document.getElementById("checkout");
    checkoutBtn.disabled = true;
    checkoutBtn.textContent = "Redirection…";

    // On envoie uniquement: priceId + quantity (le backend valide)
    const items = [];
    for (const [id, qty] of cart.entries()){
      const p = PRODUCTS.find(x => x.id === id);
      if(!p) continue;
      items.push({ priceId: p.priceId, quantity: qty });
    }

    try{
      const res = await fetch("/api/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ items })
      });

      if(!res.ok){
        const text = await res.text();
        throw new Error(text || "Erreur serveur");
      }

      const { url } = await res.json();
      window.location.href = url;
    } catch(err){
      alert("Impossible de lancer le paiement. " + err.message);
      checkoutBtn.disabled = false;
      checkoutBtn.textContent = "Commander";
    }
  }

  document.getElementById("checkout").addEventListener("click", checkout);

  renderProducts();
  updateUI();
</script>
</body>
</html>
