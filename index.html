<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="icon" type="image/png" href="/favicon.png">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mes Extras ¬∑ ELOK</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    /* ‚îÄ‚îÄ RESET & VARIABLES ‚îÄ‚îÄ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --cream: #F9F5EE;
      --warm-white: #FFFDF8;
      --sand: #E8DED0;
      --terracotta: #C4714A;
      --terracotta-dark: #A85C38;
      --forest: #2D4A3E;
      --forest-light: #3D6356;
      --charcoal: #1C1C1C;
      --mid-grey: #6B6B6B;
      --light-grey: #B8B0A6;
      --gold: #C9A84C;
      --radius: 16px;
      --radius-sm: 10px;
      --shadow: 0 4px 24px rgba(44,30,20,0.08);
      --shadow-lg: 0 12px 48px rgba(44,30,20,0.14);
    }

    html { scroll-behavior: smooth; }
    body, html {
      overflow-x: hidden;
      max-width: 100%;
    }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--cream);
      color: var(--charcoal);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      background: var(--forest);
      color: white;
      padding: 0 16px;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 20px rgba(0,0,0,0.2);
    }
    .header-inner {
      max-width: 960px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
      gap: 10px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      min-width: 0;
    }
    .logo {
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--gold);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cart-btn {
      background: var(--terracotta);
      color: white;
      border: none;
      border-radius: 40px;
      padding: 8px 16px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 7px;
      transition: background 0.2s, transform 0.15s;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .cart-btn:hover { background: var(--terracotta-dark); transform: translateY(-1px); }
    .cart-count {
      background: white;
      color: var(--terracotta);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 0.72rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }
    .cart-count.bump { animation: bump 0.3s ease; }
    @keyframes bump { 0%,100%{transform:scale(1)} 50%{transform:scale(1.4)} }

    /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
    .hero {
      background: var(--forest);
      color: white;
      padding: 56px 24px 72px;
      text-align: center;
      position: relative;
      overflow: hidden;
      margin-top: 56px;
    }
    .hero::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at 60% 0%, rgba(201,168,76,0.15) 0%, transparent 60%),
                  radial-gradient(ellipse at 20% 100%, rgba(196,113,74,0.1) 0%, transparent 50%);
    }
    .hero-content { position: relative; max-width: 600px; margin: 0 auto; }
    .hero-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(201,168,76,0.15);
      border: 1px solid rgba(201,168,76,0.4);
      color: var(--gold);
      border-radius: 40px;
      padding: 6px 16px;
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      margin-bottom: 20px;
    }
    .hero h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 700;
      line-height: 1.15;
      margin-bottom: 16px;
    }
    .hero p {
      color: rgba(255,255,255,0.72);
      font-size: 1.05rem;
      line-height: 1.65;
      max-width: 440px;
      margin: 0 auto;
    }
    .property-tag {
      display: inline-block;
      margin-top: 28px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 40px;
      padding: 8px 20px;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.7);
    }
    .property-tag strong { color: white; }

    /* ‚îÄ‚îÄ WAVE ‚îÄ‚îÄ */
    .wave { display: block; margin-top: -2px; color: var(--cream); }

    /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
    main { max-width: 960px; margin: 0 auto; padding: 0 20px 80px; }

    .section-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.6rem;
      color: var(--forest);
      margin: 48px 0 6px;
    }
    .section-sub {
      color: var(--mid-grey);
      font-size: 0.9rem;
      margin-bottom: 28px;
    }

    /* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
    .services-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card {
      background: var(--warm-white);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      transition: transform 0.22s ease, box-shadow 0.22s ease;
      display: flex;
      flex-direction: column;
      border: 1.5px solid transparent;
    }
    .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }
    .card.in-cart { border-color: var(--forest); }

    .card-emoji {
      font-size: 2.8rem;
      height: 110px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--sand) 0%, #F0E8DC 100%);
      position: relative;
    }
    .in-cart-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--forest);
      color: white;
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      display: none;
    }
    .card.in-cart .in-cart-badge { display: block; }

    .card-body {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .card-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--charcoal);
    }
    .card-desc {
      font-size: 0.85rem;
      color: var(--mid-grey);
      line-height: 1.5;
      flex: 1;
    }

    /* qty + options */
    .card-options { margin-top: 4px; }
    .card-options select, .card-options input {
      width: 100%;
      padding: 8px 12px;
      border: 1.5px solid var(--sand);
      border-radius: var(--radius-sm);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      background: var(--cream);
      color: var(--charcoal);
      margin-top: 6px;
      outline: none;
      transition: border-color 0.2s;
    }
    .card-options select:focus, .card-options input:focus { border-color: var(--forest); }
    .card-options label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--mid-grey);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px 20px;
      gap: 12px;
    }
    .card-price {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--forest);
    }
    .card-price .per { font-size: 0.75rem; font-weight: 400; color: var(--light-grey); }

    .add-btn {
      background: var(--forest);
      color: white;
      border: none;
      border-radius: 40px;
      padding: 10px 20px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
      white-space: nowrap;
    }
    .add-btn:hover { background: var(--forest-light); transform: translateY(-1px); }
    .add-btn.added { background: var(--terracotta); }

    /* ‚îÄ‚îÄ CART DRAWER ‚îÄ‚îÄ */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 200;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }
    .overlay.open { opacity: 1; pointer-events: all; }

    .drawer {
      position: fixed; top: 0; right: -420px; bottom: 0;
      width: min(420px, 100vw);
      background: var(--warm-white);
      z-index: 201;
      display: flex; flex-direction: column;
      transition: right 0.35s cubic-bezier(.4,0,.2,1);
      box-shadow: -8px 0 40px rgba(0,0,0,0.15);
    }
    .drawer.open { right: 0; }

    .drawer-header {
      padding: 24px;
      border-bottom: 1.5px solid var(--sand);
      display: flex; align-items: center; justify-content: space-between;
    }
    .drawer-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.3rem;
      color: var(--forest);
    }
    .close-btn {
      background: var(--sand); border: none; border-radius: 50%;
      width: 36px; height: 36px; cursor: pointer; font-size: 1.1rem;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .close-btn:hover { background: #d9cfc5; }

    .drawer-items {
      flex: 1; overflow-y: auto; padding: 20px 24px;
      display: flex; flex-direction: column; gap: 16px;
    }
    .empty-cart {
      text-align: center; color: var(--light-grey);
      margin: 60px auto; font-size: 0.9rem;
    }
    .empty-cart .big { font-size: 3rem; display: block; margin-bottom: 12px; }

    .cart-item {
      display: flex; align-items: center; gap: 14px;
      padding: 14px; background: var(--cream);
      border-radius: var(--radius-sm);
    }
    .cart-item-emoji { font-size: 1.8rem; }
    .cart-item-info { flex: 1; }
    .cart-item-name { font-weight: 600; font-size: 0.9rem; }
    .cart-item-detail { font-size: 0.78rem; color: var(--mid-grey); margin-top: 2px; }
    .cart-item-price { font-weight: 700; color: var(--forest); font-size: 0.95rem; }
    .remove-btn {
      background: none; border: none; cursor: pointer;
      color: var(--light-grey); font-size: 1.1rem;
      padding: 4px; border-radius: 4px; transition: color 0.2s;
    }
    .remove-btn:hover { color: var(--terracotta); }

    .drawer-footer {
      padding: 20px 24px;
      border-top: 1.5px solid var(--sand);
    }
    .total-row {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px;
    }
    .total-label { font-size: 0.85rem; color: var(--mid-grey); }
    .total-amount {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem; font-weight: 700; color: var(--forest);
    }

    .checkout-btn {
      width: 100%;
      background: var(--terracotta);
      color: white;
      border: none;
      border-radius: 40px;
      padding: 16px;
      font-family: 'DM Sans', sans-serif;
      font-size: 1rem; font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .checkout-btn:hover:not(:disabled) { background: var(--terracotta-dark); transform: translateY(-1px); }
    .checkout-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .secure-note {
      text-align: center;
      font-size: 0.75rem;
      color: var(--light-grey);
      margin-top: 12px;
      display: flex; align-items: center; justify-content: center; gap: 5px;
    }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
      background: var(--forest); color: white;
      padding: 12px 24px; border-radius: 40px;
      font-size: 0.875rem; font-weight: 500;
      z-index: 300; transition: transform 0.3s ease;
      white-space: nowrap; box-shadow: var(--shadow-lg);
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
    footer {
      text-align: center;
      padding: 32px;
      font-size: 0.8rem;
      color: var(--light-grey);
      border-top: 1px solid var(--sand);
    }

    @media (max-width: 500px) {
      .hero { padding: 40px 20px 56px; }
      .services-grid { grid-template-columns: 1fr; }
      .logo { font-size: 0.8rem; }
      .cart-btn { padding: 7px 12px; font-size: 0.8rem; }
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
<header>
  <div class="header-inner">
    <div class="header-left">
      <img src="ROND4.png" alt="ELOK" style="height: 36px; background: white; border-radius: 50%; padding: 2px; flex-shrink: 0;">
      <div class="logo">Mes services additionnels</div>
    </div>
    <button class="cart-btn" onclick="openCart()">
      üõçÔ∏è Mon panier
      <span class="cart-count" id="cartCount">0</span>
    </button>
  </div>
</header>

<!-- ‚ïê‚ïê HERO ‚ïê‚ïê -->
<div class="hero">
  <div class="hero-content">
    <div class="hero-badge">‚ú® Services exclusifs</div>
    <h1>Sublimez votre s√©jour</h1>
    <p>Ajoutez des extras √† la carte pour vivre une exp√©rience vraiment inoubliable. Paiement s√©curis√©, livraison sans tracas.</p>
    <div class="property-tag">üìç Pour votre s√©jour √† <strong id="propertyName">L'Officine</strong></div>
  </div>
</div>
<svg class="wave" viewBox="0 0 1440 40" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" height="40" style="display:block;background:var(--forest)">
  <path d="M0,40 C360,0 1080,40 1440,20 L1440,40 Z" fill="#F9F5EE"/>
</svg>

<!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
<main>
  <p class="section-title">Nos services disponibles</p>
  <p class="section-sub">S√©lectionnez ce qui vous fait envie ¬∑ Paiement unique et s√©curis√© via Stripe</p>

  <div class="services-grid" id="servicesGrid"></div>
</main>

<!-- ‚ïê‚ïê FOOTER ‚ïê‚ïê -->
<footer>Paiement 100% s√©curis√© via Stripe &nbsp;¬∑&nbsp; Aucun compte requis &nbsp;¬∑&nbsp; ¬© 2025 MaConciergerie</footer>

<!-- ‚ïê‚ïê CART DRAWER ‚ïê‚ïê -->
<div class="overlay" id="overlay" onclick="closeCart()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div class="drawer-title">üõçÔ∏è Mon panier</div>
    <button class="close-btn" onclick="closeCart()">‚úï</button>
  </div>
  <div class="drawer-items" id="drawerItems">
    <div class="empty-cart"><span class="big">üõí</span>Votre panier est vide</div>
  </div>
  <div class="drawer-footer">
    <div class="total-row">
      <div class="total-label">Total √† r√©gler</div>
      <div class="total-amount" id="totalAmount">0,00 ‚Ç¨</div>
    </div>
    <button class="checkout-btn" id="checkoutBtn" onclick="checkout()">
      üí≥ Payer maintenant
    </button>
    <div class="secure-note">üîí Paiement chiffr√© ¬∑ Powered by Stripe</div>
  </div>
</div>

<!-- ‚ïê‚ïê TOAST ‚ïê‚ïê -->
<div class="toast" id="toast"></div>

<script>
const CONFIG = {
  stripePublicKey: 'pk_live_51T2sCWEQXQOSFAvYReJfFZ9wGgP1YHoq43wY3jCoS0gr6wxVqx9gmQiyPPm8ZnJK60V8F7b1aQ1TGD4ikHomJQT000UpCnCgyB',
  checkoutEndpoint: '/.netlify/functions/create-checkout-session',
  propertyName: "L'Officine",
  currency: 'eur',
};

const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('property')) {
  CONFIG.propertyName = decodeURIComponent(urlParams.get('property'));
}
document.getElementById('propertyName').textContent = CONFIG.propertyName;

const SERVICES = [
  {
    id: 'late_checkout',
    emoji: 'üåÖ',
    name: 'D√©part tardif',
    desc: 'Quittez le logement jusqu\'√† 12h00 sans stress. Profitez d\'une derni√®re grasse mat\'.',
    price: 25,
    per: '/ s√©jour',
    stripePriceId: 'price_1T2tyPEQXQOSFAvYIvshdgEQ',
    options: [
      { label: 'Heure de d√©part', type: 'select', name: 'heure', choices: ['12h00', '13h00', '14h00'] }
    ]
  },
  {
    id: 'early_checkin',
    emoji: 'üîë',
    name: 'Arriv√©e anticip√©e',
    desc: 'Acc√©dez au logement d√®s 10h pour commencer votre s√©jour sur les chapeaux de roue.',
    price: 20,
    per: '/ s√©jour',
    stripePriceId: 'price_1T2tyPEQXQOSFAvYIvshdgEQ',
    options: [
      { label: 'Heure d\'arriv√©e', type: 'select', name: 'heure', choices: ['10h00', '11h00', '12h00'] }
    ]
  },
  {
    id: 'menage',
    emoji: '‚ú®',
    name: 'M√©nage interm√©diaire',
    desc: 'Un coup de propre au milieu du s√©jour : linge de maison frais et appartement nickel.',
    price: 45,
    per: '/ passage',
    stripePriceId: 'price_1T2tyPEQXQOSFAvYIvshdgEQ',
    options: []
  },
  {
    id: 'prosseco',
    emoji: 'ü•Ç',
    name: 'Prosseco',
    desc: 'Une bouteille de prosecco vous attend √† votre arriv√©e, au frais.',
    price: 25,
    per: '/ passage',
    stripePriceId: 'price_1T2sIbEQXQOSFAvYQOq3vbmQ',
    options: []
  },
  {
    id: 'champagne',
    emoji: 'ü•Ç',
    name: 'Bouteille de champagne',
    desc: 'Une bouteille de champagne mill√©sim√© vous attend √† votre arriv√©e, au frais.',
    price: 50,
    per: '/ bouteille',
    stripePriceId: 'price_1T2sIbEQXQOSFAvYQOq3vbmQ',
    options: [
      { label: 'Occasion', type: 'select', name: 'occasion', choices: ['Anniversaire üéÇ', 'Romantique üíï', 'C√©l√©bration üéâ', 'Autre'] }
    ]
  },
  {
    id: 'breakfast',
    emoji: 'ü•ê',
    name: 'Panier petit-d√©jeuner',
    desc: 'Croissants, jus de fruits, caf√©, confiture artisanale et viennoiseries locales.',
    price: 35,
    per: '/ pers.',
    stripePriceId: 'price_1T2sIbEQXQOSFAvYQOq3vbmQ',
    options: [
      { label: 'Nombre de personnes', type: 'select', name: 'qty', choices: ['1 personne', '2 personnes', '3 personnes', '4 personnes'] }
    ]
  },
  {
    id: 'transfer',
    emoji: 'üöñ',
    name: 'Transfert a√©roport',
    desc: 'Navette priv√©e jusqu\'√† votre a√©roport. Chauffeur en tenue, ponctualit√© garantie.',
    price: 65,
    per: '/ trajet',
    stripePriceId: 'price_1T2sIbEQXQOSFAvYQOq3vbmQ',
    options: [
      { label: 'A√©roport', type: 'select', name: 'airport', choices: ['CDG - Charles de Gaulle', 'ORY - Orly', 'BVA - Beauvais'] },
      { label: 'Date et heure (ex: 15/08 √† 09h30)', type: 'input', name: 'datetime', placeholder: 'JJ/MM √† HHhMM' }
    ]
  },
  {
    id: 'babysitting',
    emoji: 'üß∏',
    name: 'Baby-sitting',
    desc: 'Garde d\'enfants assur√©e par un professionnel dipl√¥m√© pour votre soir√©e en libert√©.',
    price: 22,
    per: '/ heure',
    stripePriceId: 'price_1T2sIbEQXQOSFAvYQOq3vbmQ',
    options: [
      { label: 'Nombre d\'heures', type: 'select', name: 'hours', choices: ['2h', '3h', '4h', '5h', '6h+'] }
    ]
  },
  {
    id: 'panier_local',
    emoji: 'üß∫',
    name: 'Panier de produits locaux',
    desc: 'S√©lection de sp√©cialit√©s r√©gionales : fromages, charcuterie, vins et douceurs.',
    price: 40,
    per: '/ panier',
    stripePriceId: 'price_1T2sIbEQXQOSFAvYQOq3vbmQ',
    options: []
  },
  {
    id: 'velo',
    emoji: 'üö≤',
    name: 'Location de v√©los',
    desc: 'Explorez la ville √† v√©lo ! Livraison et r√©cup√©ration au logement, casques inclus.',
    price: 15,
    per: '/ v√©lo/jour',
    stripePriceId: 'price_1T2sIbEQXQOSFAvYQOq3vbmQ',
    options: [
      { label: 'Nombre de v√©los', type: 'select', name: 'qty', choices: ['1 v√©lo', '2 v√©los', '3 v√©los', '4 v√©los'] },
      { label: 'Nombre de jours', type: 'select', name: 'days', choices: ['1 jour', '2 jours', '3 jours', '4 jours', '5 jours'] }
    ]
  },
  {
    id: 'lit_bebe',
    emoji: 'üë∂',
    name: 'Lit b√©b√© + mat√©riel',
    desc: 'Lit √† barreaux homologu√©, linge lav√©, chaise haute et baignoire fournis.',
    price: 30,
    per: '/ s√©jour',
    stripePriceId: 'price_1T2sIbEQXQOSFAvYQOq3vbmQ',
    options: []
  },
];

let cart = [];

function renderServices() {
  const grid = document.getElementById('servicesGrid');
  grid.innerHTML = SERVICES.map(s => `
    <div class="card" id="card-${s.id}">
      <div class="card-emoji">
        ${s.emoji}
        <div class="in-cart-badge">‚úì Ajout√©</div>
      </div>
      <div class="card-body">
        <div class="card-name">${s.name}</div>
        <div class="card-desc">${s.desc}</div>
        ${s.options.length ? `<div class="card-options">${s.options.map(o => renderOption(s.id, o)).join('')}</div>` : ''}
      </div>
      <div class="card-footer">
        <div class="card-price">
          ${s.price}‚Ç¨ <span class="per">${s.per}</span>
        </div>
        <button class="add-btn" id="btn-${s.id}" onclick="addToCart('${s.id}')">
          Ajouter
        </button>
      </div>
    </div>
  `).join('');
}

function renderOption(sid, opt) {
  if (opt.type === 'select') {
    return `
      <label>${opt.label}</label>
      <select id="opt-${sid}-${opt.name}">
        ${opt.choices.map(c => `<option>${c}</option>`).join('')}
      </select>`;
  }
  return `
    <label>${opt.label}</label>
    <input type="text" id="opt-${sid}-${opt.name}" placeholder="${opt.placeholder || ''}">`;
}

function addToCart(id) {
  const service = SERVICES.find(s => s.id === id);
  const opts = {};
  service.options.forEach(o => {
    const el = document.getElementById(`opt-${id}-${o.name}`);
    if (el) opts[o.name] = el.value;
  });
  const item = { service, options: opts, unitPrice: service.price };
  cart.push(item);
  updateCartUI();
  showToast(`${service.emoji} ${service.name} ajout√© !`);
  document.getElementById(`card-${id}`).classList.add('in-cart');
  const btn = document.getElementById(`btn-${id}`);
  btn.textContent = 'Ajout√© ‚úì';
  btn.classList.add('added');
}

function removeFromCart(index) {
  const item = cart[index];
  cart.splice(index, 1);
  const stillIn = cart.some(i => i.service.id === item.service.id);
  if (!stillIn) {
    document.getElementById(`card-${item.service.id}`)?.classList.remove('in-cart');
    const btn = document.getElementById(`btn-${item.service.id}`);
    if (btn) { btn.textContent = 'Ajouter'; btn.classList.remove('added'); }
  }
  updateCartUI();
}

function updateCartUI() {
  const count = cart.length;
  const countEl = document.getElementById('cartCount');
  countEl.textContent = count;
  countEl.classList.add('bump');
  setTimeout(() => countEl.classList.remove('bump'), 350);
  const total = cart.reduce((s, i) => s + i.unitPrice, 0);
  document.getElementById('totalAmount').textContent =
    total.toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' });
  renderCartItems();
}

function renderCartItems() {
  const el = document.getElementById('drawerItems');
  if (cart.length === 0) {
    el.innerHTML = '<div class="empty-cart"><span class="big">üõí</span>Votre panier est vide</div>';
    return;
  }
  el.innerHTML = cart.map((item, i) => `
    <div class="cart-item">
      <div class="cart-item-emoji">${item.service.emoji}</div>
      <div class="cart-item-info">
        <div class="cart-item-name">${item.service.name}</div>
        <div class="cart-item-detail">${Object.values(item.options).join(' ¬∑ ') || ''}</div>
      </div>
      <div class="cart-item-price">${item.unitPrice}‚Ç¨</div>
      <button class="remove-btn" onclick="removeFromCart(${i})">üóë</button>
    </div>
  `).join('');
}

function openCart() {
  document.getElementById('overlay').classList.add('open');
  document.getElementById('drawer').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeCart() {
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('drawer').classList.remove('open');
  document.body.style.overflow = '';
}

let toastTimer;
function showToast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2800);
}

async function checkout() {
  if (cart.length === 0) { showToast('Ajoutez au moins un service üòä'); return; }
  const btn = document.getElementById('checkoutBtn');
  btn.disabled = true;
  btn.textContent = 'Chargement‚Ä¶';
  try {
    const lineItems = cart.map(item => ({
      price: item.service.stripePriceId,
      quantity: 1,
    }));
    const metadata = {
      property: CONFIG.propertyName,
      items: JSON.stringify(cart.map(i => ({ name: i.service.name, options: i.options })))
    };
    const res = await fetch(CONFIG.checkoutEndpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        line_items: lineItems,
        metadata,
        success_url: window.location.href + '?success=1',
        cancel_url: window.location.href,
      })
    });
    const { url, error } = await res.json();
    if (error) throw new Error(error);
    if (url) window.location.href = url;
  } catch (e) {
    console.error(e);
    showToast('Erreur de paiement ‚Äî r√©essayez üôè');
    btn.disabled = false;
    btn.innerHTML = 'üí≥ Payer maintenant';
  }
}

if (urlParams.get('success') === '1') {
  setTimeout(() => showToast('üéâ Merci ! Votre commande a bien √©t√© re√ßue.'), 500);
}

renderServices();
</script>

</html>











